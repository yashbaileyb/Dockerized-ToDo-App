version: 2.1

jobs:
  build_and_push:
    docker:
      - image: cimg/node:20.3.1
    steps:
      - checkout
      - setup_remote_docker

      - run:
          name: Build and Push Docker Image
          command: |
            VERSION="build-${CIRCLE_WORKFLOW_ID:0:7}"
            echo "${VERSION}" > image_tag.txt

            docker build -f AppCode/Dockerfile \
              -t yashyb11/to-do-app:${VERSION} AppCode

            echo "${DOCKER_PASSWORD}" | docker login \
              -u "${DOCKER_USERNAME}" --password-stdin

            docker push yashyb11/to-do-app:${VERSION}

      - persist_to_workspace:
          root: .
          paths:
            - image_tag.txt

  update_manifest:
    docker:
      - image: cimg/base:2023.06
    steps:
      - checkout

      - attach_workspace:
          at: ~/project

      - run:
          name: Update Kubernetes Deployment Manifest
          command: |
            TAG=$(cat ~/project/image_tag.txt)
            echo "Using image tag: ${TAG}"

            git config --global user.email "yashbaile19@gmail.com"
            git config --global user.name "yashbaileyb"

            cd kube_manifest

            git checkout deployment || git checkout -b deployment

            sed -i "s|image: .*|image: yashyb11/to-do-app:${TAG}|g" manifest/deployment.yaml

            git add manifest/deployment.yaml
            git commit -m "Update image tag to ${TAG}" || echo "No changes"

            git remote set-url origin https://yashbaileyb:${GITHUB_TOKEN}@github.com/yashbaileyb/Dockerized-ToDo-App.git
            git push origin deployment

workflows:
  GitOpsflow:
    jobs:
      - build_and_push:
          filters:
            branches:
              only:
                - main

      - update_manifest:
          requires:
            - build_and_push
          filters:
            branches:
              only:
                - main
